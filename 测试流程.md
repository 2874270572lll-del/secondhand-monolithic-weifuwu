# 二手交易平台单体版测试流程

## 一、环境准备

### 1. 安装MySQL数据库
确保MySQL已安装并运行在localhost:3306

### 2. 创建数据库
```sql
CREATE DATABASE secondhand_db CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
```

### 3. 配置数据库用户
确保application.yml中配置的用户名和密码正确：
- 用户名：root
- 密码：root

如果需要修改，请编辑 `src/main/resources/application.yml`

### 4. 安装Maven
确保系统已安装Maven 3.6+

### 5. 安装JDK
确保已安装JDK 17或更高版本（项目配置为Java 25，如果没有，请修改pom.xml中的java.version为你的JDK版本）

## 二、启动项目

### 方式一：使用Maven命令
```bash
cd secondhand-monolithic
mvn clean install
mvn spring-boot:run
```

### 方式二：使用IDE
1. 用IDEA或Eclipse导入项目
2. 等待Maven依赖下载完成
3. 运行 `SecondhandMonolithicApplication.java` 主类

### 启动成功标志
看到以下日志表示启动成功：
```
Started SecondhandMonolithicApplication in X seconds
```

应用将运行在：`http://localhost:8080/api`

## 三、API测试工具准备

推荐使用以下任一工具：
- **Postman** (推荐)
- **Apifox**
- **curl命令**
- **IDEA HTTP Client**

## 四、完整业务流程测试

### 测试场景：用户注册 -> 发布商品 -> 下单购买 -> 发货收货 -> 评论

---

## 步骤1：用户注册

### 1.1 注册卖家用户
**请求**
```
POST http://localhost:8080/api/users
Content-Type: application/json

{
  "username": "seller01",
  "password": "123456",
  "email": "seller01@example.com",
  "phone": "13800138001",
  "address": "浙江省杭州市西湖区"
}
```

**期望响应**
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "id": 1,
    "username": "seller01",
    "email": "seller01@example.com",
    "phone": "13800138001",
    "address": "浙江省杭州市西湖区",
    "status": 1,
    "createTime": "2025-12-18 14:30:00",
    "updateTime": "2025-12-18 14:30:00"
  }
}
```

### 1.2 注册买家用户
**请求**
```
POST http://localhost:8080/api/users
Content-Type: application/json

{
  "username": "buyer01",
  "password": "123456",
  "email": "buyer01@example.com",
  "phone": "13900139001",
  "address": "浙江省杭州市滨江区"
}
```

**期望响应**
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "id": 2,
    "username": "buyer01",
    "email": "buyer01@example.com",
    "phone": "13900139001",
    "address": "浙江省杭州市滨江区",
    "status": 1,
    "createTime": "2025-12-18 14:31:00",
    "updateTime": "2025-12-18 14:31:00"
  }
}
```

---

## 步骤2：用户登录

### 2.1 卖家登录
**请求**
```
POST http://localhost:8080/api/users/login
Content-Type: application/json

{
  "username": "seller01",
  "password": "123456"
}
```

**期望响应**
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "id": 1,
    "username": "seller01",
    "email": "seller01@example.com"
  }
}
```

### 2.2 买家登录
**请求**
```
POST http://localhost:8080/api/users/login
Content-Type: application/json

{
  "username": "buyer01",
  "password": "123456"
}
```

---

## 步骤3：卖家发布商品

### 3.1 发布商品1 - iPhone 13
**请求**
```
POST http://localhost:8080/api/products
Content-Type: application/json

{
  "name": "二手iPhone 13 128GB",
  "description": "九成新，无划痕，功能完好，原装充电器",
  "price": 3999.00,
  "category": "数码产品",
  "stock": 1,
  "imageUrl": "http://example.com/iphone13.jpg",
  "sellerId": 1
}
```

**期望响应**
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "id": 1,
    "name": "二手iPhone 13 128GB",
    "description": "九成新，无划痕，功能完好，原装充电器",
    "price": 3999.00,
    "category": "数码产品",
    "stock": 1,
    "imageUrl": "http://example.com/iphone13.jpg",
    "status": 1,
    "sellerId": 1,
    "createTime": "2025-12-18 14:35:00",
    "updateTime": "2025-12-18 14:35:00"
  }
}
```

### 3.2 发布商品2 - MacBook
**请求**
```
POST http://localhost:8080/api/products
Content-Type: application/json

{
  "name": "MacBook Pro 2020 13寸",
  "description": "8G内存，256G硬盘，M1芯片，成色好",
  "price": 6999.00,
  "category": "数码产品",
  "stock": 1,
  "imageUrl": "http://example.com/macbook.jpg",
  "sellerId": 1
}
```

### 3.3 发布商品3 - 自行车
**请求**
```
POST http://localhost:8080/api/products
Content-Type: application/json

{
  "name": "捷安特山地自行车",
  "description": "骑行不到500公里，几乎全新",
  "price": 1200.00,
  "category": "运动器材",
  "stock": 1,
  "imageUrl": "http://example.com/bike.jpg",
  "sellerId": 1
}
```

---

## 步骤4：买家浏览商品

### 4.1 获取所有上架商品
**请求**
```
GET http://localhost:8080/api/products/status/1
```

**期望响应**
```json
{
  "code": 200,
  "message": "success",
  "data": [
    {
      "id": 1,
      "name": "二手iPhone 13 128GB",
      "price": 3999.00,
      "category": "数码产品",
      "status": 1
    },
    {
      "id": 2,
      "name": "MacBook Pro 2020 13寸",
      "price": 6999.00,
      "category": "数码产品",
      "status": 1
    },
    {
      "id": 3,
      "name": "捷安特山地自行车",
      "price": 1200.00,
      "category": "运动器材",
      "status": 1
    }
  ]
}
```

### 4.2 按类别搜索商品
**请求**
```
GET http://localhost:8080/api/products/category/数码产品
```

### 4.3 关键词搜索商品
**请求**
```
GET http://localhost:8080/api/products/search?keyword=iPhone
```

### 4.4 查看商品详情
**请求**
```
GET http://localhost:8080/api/products/1
```

---

## 步骤5：买家下单

### 5.1 创建订单购买iPhone
**请求**
```
POST http://localhost:8080/api/orders
Content-Type: application/json

{
  "buyerId": 2,
  "productId": 1,
  "shippingAddress": "浙江省杭州市滨江区XX路XX号",
  "contactPhone": "13900139001"
}
```

**期望响应**
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "id": 1,
    "orderNo": "ORD1734506400000ABCD1234",
    "buyerId": 2,
    "sellerId": 1,
    "productId": 1,
    "totalAmount": 3999.00,
    "status": 0,
    "shippingAddress": "浙江省杭州市滨江区XX路XX号",
    "contactPhone": "13900139001",
    "createTime": "2025-12-18 14:40:00"
  }
}
```

**记录订单ID：1**

---

## 步骤6：买家支付订单

### 6.1 支付订单
**请求**
```
PUT http://localhost:8080/api/orders/1/pay
```

**期望响应**
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "id": 1,
    "orderNo": "ORD1734506400000ABCD1234",
    "status": 1,
    "payTime": "2025-12-18 14:42:00"
  }
}
```

**验证：商品库存应该减少**
```
GET http://localhost:8080/api/products/1
```
预期stock变为0，status变为2（已售出）

---

## 步骤7：卖家查看订单并发货

### 7.1 卖家查看自己的订单
**请求**
```
GET http://localhost:8080/api/orders/seller/1
```

### 7.2 卖家发货
**请求**
```
PUT http://localhost:8080/api/orders/1/ship
```

**期望响应**
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "id": 1,
    "status": 2,
    "shipTime": "2025-12-18 14:45:00"
  }
}
```

---

## 步骤8：买家确认收货

### 8.1 买家查看自己的订单
**请求**
```
GET http://localhost:8080/api/orders/buyer/2
```

### 8.2 买家确认收货
**请求**
```
PUT http://localhost:8080/api/orders/1/finish
```

**期望响应**
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "id": 1,
    "status": 3,
    "finishTime": "2025-12-18 15:00:00"
  }
}
```

---

## 步骤9：买家评论

### 9.1 发布评论
**请求**
```
POST http://localhost:8080/api/comments
Content-Type: application/json

{
  "orderId": 1,
  "userId": 2,
  "content": "卖家很好，手机成色不错，物流也很快！",
  "rating": 5
}
```

**期望响应**
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "id": 1,
    "productId": 1,
    "userId": 2,
    "orderId": 1,
    "content": "卖家很好，手机成色不错，物流也很快！",
    "rating": 5,
    "createTime": "2025-12-18 15:10:00"
  }
}
```

### 9.2 查看商品的所有评论
**请求**
```
GET http://localhost:8080/api/comments/product/1
```

---

## 五、异常场景测试

### 测试1：重复用户名注册
**请求**
```
POST http://localhost:8080/api/users
Content-Type: application/json

{
  "username": "seller01",
  "password": "123456",
  "email": "another@example.com"
}
```

**期望响应**
```json
{
  "code": 500,
  "message": "Username already exists",
  "data": null
}
```

### 测试2：错误的登录密码
**请求**
```
POST http://localhost:8080/api/users/login
Content-Type: application/json

{
  "username": "seller01",
  "password": "wrongpassword"
}
```

**期望响应**
```json
{
  "code": 500,
  "message": "Invalid username or password",
  "data": null
}
```

### 测试3：购买已售出的商品
**请求**
```
POST http://localhost:8080/api/orders
Content-Type: application/json

{
  "buyerId": 2,
  "productId": 1,
  "shippingAddress": "test",
  "contactPhone": "123"
}
```

**期望响应**
```json
{
  "code": 500,
  "message": "Product is not available",
  "data": null
}
```

### 测试4：重复支付订单
**请求**
```
PUT http://localhost:8080/api/orders/1/pay
```

**期望响应**
```json
{
  "code": 500,
  "message": "Order cannot be paid",
  "data": null
}
```

### 测试5：未完成订单就评论
创建新订单但不支付，然后尝试评论：

**期望响应**
```json
{
  "code": 500,
  "message": "Order is not finished, cannot comment",
  "data": null
}
```

---

## 六、其他功能测试

### 1. 用户管理

#### 获取所有用户
```
GET http://localhost:8080/api/users
```

#### 根据ID获取用户
```
GET http://localhost:8080/api/users/1
```

#### 根据用户名获取用户
```
GET http://localhost:8080/api/users/username/seller01
```

#### 更新用户信息
```
PUT http://localhost:8080/api/users/1
Content-Type: application/json

{
  "username": "seller01",
  "password": "123456",
  "email": "seller01_new@example.com",
  "phone": "13800138002",
  "address": "浙江省杭州市西湖区新地址"
}
```

#### 删除用户
```
DELETE http://localhost:8080/api/users/1
```

### 2. 商品管理

#### 获取所有商品
```
GET http://localhost:8080/api/products
```

#### 获取卖家的所有商品
```
GET http://localhost:8080/api/products/seller/1
```

#### 更新商品信息
```
PUT http://localhost:8080/api/products/1
Content-Type: application/json

{
  "name": "二手iPhone 13 128GB - 降价啦",
  "description": "九成新，无划痕，功能完好，原装充电器，急售",
  "price": 3799.00,
  "category": "数码产品",
  "stock": 1,
  "imageUrl": "http://example.com/iphone13.jpg"
}
```

#### 商品下架
```
PUT http://localhost:8080/api/products/1/status/0
```

#### 商品上架
```
PUT http://localhost:8080/api/products/1/status/1
```

#### 删除商品
```
DELETE http://localhost:8080/api/products/1
```

### 3. 订单管理

#### 获取所有订单
```
GET http://localhost:8080/api/orders
```

#### 根据订单号查询
```
GET http://localhost:8080/api/orders/orderNo/ORD1734506400000ABCD1234
```

#### 根据状态查询订单
```
GET http://localhost:8080/api/orders/status/1
```

#### 取消订单（仅待支付状态）
```
DELETE http://localhost:8080/api/orders/1
```

### 4. 评论管理

#### 获取所有评论
```
GET http://localhost:8080/api/comments
```

#### 获取用户的所有评论
```
GET http://localhost:8080/api/comments/user/2
```

#### 删除评论
```
DELETE http://localhost:8080/api/comments/1
```

---

## 七、数据库验证

连接MySQL数据库，查看数据是否正确保存：

```sql
USE secondhand_db;

-- 查看所有表
SHOW TABLES;

-- 查看用户数据
SELECT * FROM users;

-- 查看商品数据
SELECT * FROM products;

-- 查看订单数据
SELECT * FROM orders;

-- 查看评论数据
SELECT * FROM comments;

-- 验证订单状态流转
SELECT id, order_no, status, pay_time, ship_time, finish_time FROM orders;

-- 验证商品库存变化
SELECT id, name, stock, status FROM products;
```

---

## 八、测试检查清单

- [ ] 用户可以成功注册
- [ ] 用户可以成功登录
- [ ] 重复用户名/邮箱注册会报错
- [ ] 错误密码登录会报错
- [ ] 卖家可以发布商品
- [ ] 商品可以上架/下架
- [ ] 买家可以浏览商品列表
- [ ] 买家可以搜索商品
- [ ] 买家可以按类别筛选
- [ ] 买家可以创建订单
- [ ] 订单支付后库存会减少
- [ ] 订单状态可以正常流转（待支付->已支付->已发货->已完成）
- [ ] 只有已完成订单才能评论
- [ ] 评论可以正常发布和查看
- [ ] 所有异常情况都有适当的错误提示
- [ ] 数据库数据正确保存

---

## 九、性能测试（可选）

使用JMeter或Apache Bench进行压力测试：

```bash
# 使用ab工具测试商品列表接口
ab -n 1000 -c 10 http://localhost:8080/api/products/status/1
```

---

## 十、日志查看

查看应用日志，确认SQL语句和业务逻辑执行正常：

```bash
# 查看控制台输出
# 应该能看到Hibernate生成的SQL语句
# 以及业务日志输出
```
